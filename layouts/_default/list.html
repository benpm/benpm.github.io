{{ define "styles" }}
    {{ $.Scratch.Set "style_opts" (dict "src" "scss/pages/posts.scss" "dest" "css/posts.css") }}
{{ end }}

{{ define "main" }}

{{ $dateFormat := .Site.Params.dateFormat | default "Jan 2 2006" }}

<header class="list__header">
  <h1 id="list__title">{{ .Title }}</h1>
</header>
<div class="list__desc">
  {{ partial "anchored-headings.html" .Content }}
</div>

{{ if .Params.filter_categories }}
  {{/* Collect unique categories from all pages */}}
  {{ $categories := slice }}
  {{ range .Pages }}
    {{ if .Params.Category }}
      {{ range (split .Params.Category ",") }}
        {{ $cat := trim . " " }}
        {{ if and $cat (not (in $categories $cat)) }}
          {{ $categories = $categories | append $cat }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $categories = sort $categories }}
  <div class="category-filter">
    <button class="category-filter__btn" data-category="all">all</button>
    {{ range $categories }}
    <button class="category-filter__btn{{ if eq . "graphics" }} active{{ end }}" data-category="{{ . }}">{{ . }}</button>
    {{ end }}
  </div>
{{ end }}

<div class="post-list__container">
  <ul class="post-list">
    {{ range .Pages.ByDate.Reverse }}
    <li class="post"{{ if .Params.Category }} data-categories="{{ .Params.Category }}"{{ end }}>
      <div class="post__header">
        <div class="post-date__container">
          {{ if not .Params.is_wip }}
            <time class="post-date" datetime="{{ .Date }}">{{ .Date.Format $dateFormat }}</time>
          {{ else }}
            <time class="post-date wip" datetime="{{ now }}">WIP</time>
          {{ end }}
        </div>
        <h2 class="post__title">
          {{ if .Params.Outlink }}
            <a href="{{.Params.Outlink}}" target="_blank">{{ .Title }}</a>
          {{ else }}
            <a href="{{.RelPermalink}}">{{ .Title }}</a>
          {{ end }}
          {{ if .Params.Category }}
            <span class="post__category">
              ({{.Params.Category}})
            </span>
          {{ end }}
        </h2>
        {{ partial "tags.html" .}}
      </div>
      <div class="post__desc">
        <p>{{ .Params.Description }}
        </p>
      </div>
      {{ if .Params.Img }}
        {{ if .Params.Outlink }}
          <a href="{{.Params.Outlink}}" target="_blank">
        {{ else }}
          <a href="{{.RelPermalink}}">
        {{ end }}
        {{/*  Create background video embed if image has .webm extension  */}}
        {{ if eq (path.Ext .Params.Img) ".webm" }}
          <div class="post__video-container">
            <video class="post__video" autoplay loop muted playsinline>
              <source src="{{ .Params.Img }}" type="video/webm">
            </video>
          </div>
        {{ else }}
          <div class="post__img-container" style="background-image: url('{{ .Params.Img }}');"></div>
        {{ end }}
        </a>
      {{ end }}
    </li>
    {{ end }}
  </ul>
  {{ if (eq .Section "blog") }}
  {{ partial "browse-by-tag.html" .}}
  {{ end }}
</div>

{{ end }}

{{ define "scripts" }}
{{ if .Params.filter_categories }}
<script>
(function () {
  const btns = document.querySelectorAll('.category-filter__btn');
  const posts = document.querySelectorAll('.post-list .post');

  function applyFilter(selected) {
    btns.forEach(b => b.classList.toggle('active', b.dataset.category === selected));
    posts.forEach(post => {
      if (selected === 'all') {
        post.hidden = false;
      } else {
        const cats = (post.dataset.categories || '').split(',').map(c => c.trim());
        post.hidden = !cats.includes(selected);
      }
    });
  }

  btns.forEach(btn => {
    btn.addEventListener('click', () => applyFilter(btn.dataset.category));
  });

  // Apply default filter on load
  const defaultBtn = document.querySelector('.category-filter__btn.active');
  if (defaultBtn) applyFilter(defaultBtn.dataset.category);
}());
</script>
{{ end }}
{{ end }}
