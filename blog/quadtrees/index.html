<!doctype html><html lang=en-us><head><title>Quadtrees for 2D Games with Moving Elements | benpm.github.io</title><meta charset=utf-8><meta name=language content="en"><meta name=description content="How to use quadtrees for 2D top-down collisions, search, when the elements are constantly in motion"><meta name=keywords content="quadtree ,game physics ,top-down ,spatial hashing ,search ,tiletest"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=twitter:card content="summary"><meta name=twitter:title content="Quadtrees for 2D Games with Moving Elements"><meta name=twitter:description content="How to use quadtrees for 2D top-down collisions, search, when the elements are constantly in motion"><meta name=twitter:site content="https://twitter.com/_bpmw"><meta name=twitter:creator content="https://twitter.com/_bpmw"><link rel="shortcut icon" type=image/png href=/favicon.ico><link type=text/css rel=stylesheet href=/css/post.min.57af32a31da1dd8779986b17dfd4cfa16ea6c8459de8d75557e809ee305f95fc.css integrity="sha256-V68yox2h3Yd5mGsX39TPoW6myEWd6NdVV+gJ7jBflfw="><link type=text/css rel=stylesheet href=/css/custom.min.6ba4429660c66aec788de21bf85860661fd32b14601930347808b5bf194979c9.css integrity="sha256-a6RClmDGaux4jeIb+FhgZh/TKxRgGTA0eAi1vxlJeck="><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/benpm.github.io\/"},"articleSection":"blog","name":"Quadtrees for 2D Games with Moving Elements","headline":"Quadtrees for 2D Games with Moving Elements","description":"How to use quadtrees for 2D top-down collisions, search, when the elements are constantly in motion","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2020","datePublished":"2020-09-20 10:41:59 -0600 -0600","dateModified":"2020-09-20 10:41:59 -0600 -0600","url":"https:\/\/benpm.github.io\/blog\/quadtrees\/","wordCount":"536","keywords":["quadtree","game physics","top-down","spatial hashing","search","tiletest","Blog"]}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PPST2B8G8Z"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-PPST2B8G8Z');</script></head><body><div class=burger__container><div class=burger aria-controls=navigation aria-label=Menu><div class="burger__meat burger__meat--1"></div><div class="burger__meat burger__meat--2"></div><div class="burger__meat burger__meat--3"></div></div></div><nav class=nav id=navigation><ul class=nav__list><li><a href=/>_splash</a><div class=indicator></div></li><li><a class=active href=/blog>blog</a><div class="indicator active"></div></li><li><a href=/experiments>experiments</a><div class=indicator></div></li><li><a href=/gamedev>gamedev</a><div class=indicator></div></li><li><a href=/music>music</a><div class=indicator></div></li><li><a href=/projects>projects</a><div class=indicator></div></li></ul></nav><main><div class=flex-wrapper><div class=post__container><div class=post><header class=post__header><h1 id=post__title>Quadtrees for 2D Games with Moving Elements</h1><time datetime="2020-09-20 10:41:59 -0600 -0600" class=post__date>Sep 20 2020</time></header><article class=post__content><p>A quadtree is a very useful data structure for performing spatial searches. I am currently using them in <a href=/gamedev/#tiletest>Tiletest</a> for collision detection and monster behavior. Quadtrees partition 2D space into quadrants (stored as nodes in a tree), dividing these quadrants into smaller quadrants when they contain more than a certain threshold of elements (shown as dots):</p><p><img class="invertable drawing" src=/images/quadtrees/quadrant_division.png alt="Quadrant division"></p><p>There are a couple uses for this structure, one of the most useful is searching for the nearest element to a given location.</p><h2 id=nearest-element-to-chosen-location>Nearest Element to Chosen Location<a class=anchor href=#nearest-element-to-chosen-location>#</a></h2><p>To find the nearest element to a chosen location, there are <a href=https://stackoverflow.com/a/32412425/2909339 target=_blank rel="noreferrer noopener">many algorithms out there</a>. I went with a simple yet efficient one, a breadth-first search with quadrant exclusion. First, we look through each leaf node at the highest level of the tree, keeping track of the closest element we&rsquo;ve found so far. Then, we check the next level of the tree, and so on. The exclusion part is just skipping our search of nodes that cannot contain a closer element than the closest we&rsquo;ve found so far. Here&rsquo;s a simple example:</p><p><img class="invertable drawing" src=/images/quadtrees/quadrant_exclusion.png alt="Exclusion of nodes based on signed distance"></p><p>To do this, we calculate the smallest distance (shown as blue lines) from our search location (the blue dot) to a node&rsquo;s rectangular boundary. This gives us the shortest distance an element of this node could possibly have. If that shortest distance is farther than the nearest element so far (red dot), we don&rsquo;t search it <em>or</em> its children (excluded nodes are shown in grey).</p><p>This works fairly well on its own, but to make it more efficient, we will also try to search the closest nodes first. This avoids extra data structure accesses by excluding nodes as early as possible.</p><p>Here you can see this algorithm in action:</p><p class=codepen data-height=431 data-theme-id=light data-default-tab=result data-user=_bm data-slug-hash=ExPBMrW style="height:431px;box-sizing:border-box;display:flex;align-items:center;justify-content:center;border:2px solid;margin:2em 0;padding:1em" data-pen-title="AABB Collisions Test"></p><script async src=https://static.codepen.io/assets/embed/ei.js></script><p>This is just a static set of elements, though. Things get a little tricky when the elements are constantly moving.</p><h2 id=dealing-with-moving-elements--relocation>Dealing With Moving Elements / Relocation<a class=anchor href=#dealing-with-moving-elements--relocation>#</a></h2><p>The naive solution to moving elements is to walk through the whole tree, checking if each element&rsquo;s position is truly within the bounds of its current parent node, reinserting those that have do not pass the check.</p><p>This solution can be improved, as it needs to traverse the whole tree in order to perform relocation. Instead, let&rsquo;s have the elements themselves keep track of which node they are children of. This way, we can check that they are within bounds without traversing the tree. If an element has moved outside its bounds, then we reinsert it.</p><p>Another optimization involves not worrying about leftover empty leaf nodes. Checking if the parent node we just removed from is easy enough, but sometimes if we remove an element from the last populated node of its siblings, the parent node won&rsquo;t get removed. To solve this we can either check all ancestors of a node each time we remove an element (expensive), or we can worry about it later (the lazy, cheap choice, better when lots of elements are moving constantly).</p><p>In Tiletest, this has led to a huge performance improvement as many entities need information about their neighbors every tick. Here you can see slimes grouping together, which is done by finding the nearest slime and moving away from it each tick:</p><p><img src=/images/quadtrees/2020-10-20_20-21.png alt=tiletest></p><p>More updates on the game later!</p></article><ul class=tags__list><li class=tag__item><a class=tag__link href=https://benpm.github.io/tags/tiletest/>tiletest</a></li><li class=tag__item><a class=tag__link href=https://benpm.github.io/tags/gamedev/>gamedev</a></li></ul><div class=pagination><a class=pagination__item href=https://benpm.github.io/blog/gol_1/><span class=pagination__label>Previous Post</span>
<span class=pagination__title>Cellular Automata in WebGL: Part 1</span></a>
<a class=pagination__item href=https://benpm.github.io/blog/how-to-invert/reverse/transform-a-map-at-compile-time-in-c++/><span class=pagination__label>Next Post</span>
<span class=pagination__title>C++ Invert Map at Compile Time</span></a></div><footer class=post__footer><div class=social-icons><a class=social-icons__link title=Twitter href=https://twitter.com/_bpmw target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://benpm.github.io/svg/twitter.svg)></div></a><a class=social-icons__link title=GitHub href=https://github.com/benpm target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://benpm.github.io/svg/github.svg)></div></a><a class=social-icons__link title=YouTube href=https://www.youtube.com/c/BenjaminMastripolito target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://benpm.github.io/svg/youtube.svg)></div></a><a class=social-icons__link title=SoundCloud href=https://soundcloud.com/trope target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://benpm.github.io/svg/soundcloud.svg)></div></a><a class=social-icons__link title=ItchIO href=https://ben-m.itch.io/ target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://benpm.github.io/svg/itchio.svg)></div></a><a class=social-icons__link title=ko-fi href=https://ko-fi.com/benpm target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://benpm.github.io/svg/ko-fi.svg)></div></a></div><p></p></footer></div></div></div></main><script src=/js/index.min.49e4d8a384357d9b445b87371863419937ede9fa77737522ffb633073aebfa44.js integrity="sha256-SeTYo4Q1fZtEW4c3GGNBmTft6fp3c3Ui/7YzBzrr+kQ=" crossorigin=anonymous></script><script src=https://unpkg.com/prismjs@1.20.0/components/prism-core.min.js></script><script src=https://unpkg.com/prismjs@1.20.0/plugins/autoloader/prism-autoloader.min.js data-autoloader-path=https://unpkg.com/prismjs@1.20.0/components/></script><script src=/js/theme_toggle.min.849493ff7ff93f4d1ced5d05d4e096c9968165968b41ebbe21a57f3690305a10.js integrity="sha256-hJST/3/5P00c7V0F1OCWyZaBZZaLQeu+IaV/NpAwWhA=" crossorigin=anonymous></script><div id=theme-toggle-button class=invertable onclick=toggleTheme()></div></body></html>